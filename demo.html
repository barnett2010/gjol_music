<!DOCTYPE html>
<html>
<head>
    <title>在线转换</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/base-min.css">
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">

    <!--[if lte IE 8]>
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="./demo/style.css">

    <script type="text/javascript" src="./demo/translator.js"></script>

    <script type="text/javascript">
        //https://purecss.io/start/
        var name;

        function disableSubmit() {
            if (event.preventDefault)
                event.preventDefault();
            else
                event.returnValue = false;
        }

        function openMusicXML(e) {
            if (window.FileReader) {
                var reader = new FileReader();
                reader.onload = function () {
                    var data = reader.result;
                    if (data)
                        document.getElementById('source').value = data;
                };
                reader.onerror = function () {
                    alert(reader.error.message);
                };

                var input = e.target;
                var file = input.files[ 0 ];
                name = file.name;
                reader.readAsText(file);
            } else {
                alert('你的浏览器太落后了,请自行将MusicXML的内容粘贴到源');
            }
        }

        function doTranslate() {
            var data = document.getElementById('source').value;
            var target = document.getElementById('target');

            target.value = '';

            var translator = new Translator(data);
            var result = translator.translate();
            target.value = result || '';
        }

        function doSaveAs() {
            var anchor = document.getElementById('anchor');
            var val = document.getElementById('target').value;
            var blob = new Blob([ val ], { type : 'text/plain' });
            anchor.download = (name || 'html') + '.gjm';
            anchor.href = (window.webkitURL || window.URL).createObjectURL(blob);
            anchor.dataset.downloadurl = [ 'text/plain', anchor.download, anchor.href ].join(':');
        }
    </script>
</head>

<body>

<div class="pure-g">
    <div class="pure-u-1">
        <h2>MusicXML -> GJM</h2>
        <p>不要使用 <b style="color:red;">IE</b> !!!</p>
    </div>
    <div class="pure-u-1 pure-u-md-1-2">
        <form class="pure-form pure-form-stacked" action="#" onsubmit="disableSubmit();">
            <label for="file-upload" class="pure-button">打开...</label>
            <input id="file-upload" type="file" accept="application/vnd.recordare.musicxml+xml" onchange="openMusicXML(event);" hidden/>
            <label for="source">MusicXML:</label>
            <textarea id="source" title="MusicXML"></textarea>
        </form>
    </div>
    <div class="pure-u-1 pure-u-md-1-2">
        <form class="pure-form pure-form-stacked" action="#" onsubmit="disableSubmit();">
            <button class="pure-button" onclick="doTranslate();">转化...</button>
            <a href="javascript:void(0);" class="pure-button" onclick="doSaveAs();" id="anchor">下载...</a>
            <label for="target">GJM:</label>
            <textarea id="target" title="GJM" readonly></textarea>
        </form>
    </div>
    <div class="pure-u-1 notes">
        <div class="note">
            <div class="date">2018.08.24</div>
            <span>更新:</span>
            <ul class="update">
                <li>琶音,连音处理</li>
                <li>休止符的节拍处理</li>
            </ul>
            <span>计划:</span>
            <ul class="todo">
                <li>计算正确的DurationStampMax</li>
                <li>自定义一些属性</li>
            </ul>
        </div>
        <div class="note">
            <div class="date">2018.08.24</div>
            <span>修正:</span>
            <ul class="fix">
                <li>修正因为默认的Array.forEach事件没有终止条件而引发的各种问题</li>
                <li>修正MeasureKeySignatureMap因为值是0时导致的值空白</li>
            </ul>
            <span>计划:</span>
            <ul class="todo">
                <li>根据节拍计算正确的休止符</li>
                <li>处理琶音</li>
            </ul>
        </div>
    </div>
</div>
</body>
</html>
